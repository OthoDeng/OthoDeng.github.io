{"version":3,"file":"render-dev-html-child.js","names":["require","install","sysPath","fs","slash","getPosition","stackObject","filename","line","column","filteredStack","filter","s","test","splitLine","length","match","split","splitLength","Number","err","parseError","directory","componentPath","stack","position","join","sep","slice","sourceContent","readFileSync","e","trueFileName","includes","relative","message","exports","renderHTML","path","htmlComponentRendererPath","publicDir","isClientOnlyPage","error","undefined","Promise","resolve","reject","htmlComponentRenderer","process","env","GATSBY_EXPERIMENTAL_DEV_SSR","default","_throwAway","htmlString","catch","deleteModuleCache","cache"],"sources":["../../../src/utils/dev-ssr/render-dev-html-child.js"],"sourcesContent":["// TODO: Do not use source-map-support and migrate to a package that doesn't use source-map under the hood\nrequire(`source-map-support`).install()\nconst sysPath = require(`path`)\nconst fs = require(`fs-extra`)\nconst { slash } = require(`gatsby-core-utils`)\n\nconst getPosition = function (stackObject) {\n  let filename\n  let line\n  let column\n  // Because the JavaScript error stack has not yet been standardized,\n  // wrap the stack parsing in a try/catch for a soft fail if an\n  // unexpected stack is encountered.\n  try {\n    const filteredStack = stackObject.filter(function (s) {\n      return /\\(.+?\\)$/.test(s)\n    })\n    let splitLine\n    // For current Node & Chromium Error stacks\n    if (filteredStack.length > 0) {\n      splitLine = filteredStack[0].match(/(?:\\()(.+?)(?:\\))$/)[1].split(`:`)\n      // For older, future, or otherwise unexpected stacks\n    } else {\n      splitLine = stackObject[0].split(`:`)\n    }\n    const splitLength = splitLine.length\n    filename = splitLine[splitLength - 3]\n    line = Number(splitLine[splitLength - 2])\n    column = Number(splitLine[splitLength - 1])\n  } catch (err) {\n    filename = ``\n    line = 0\n    column = 0\n  }\n  return {\n    filename,\n    line,\n    column,\n  }\n}\n\n// Code borrowed and modified from https://github.com/watilde/parse-error\nconst parseError = function ({ err, directory, componentPath }) {\n  const stack = err.stack ? err.stack : ``\n  const stackObject = stack.split(`\\n`)\n  const position = getPosition(stackObject)\n\n  // Remove the `/lib/` added by webpack\n  const filename = sysPath.join(\n    directory,\n    // Don't need to use path.sep as webpack always uses a single forward slash\n    // as a path separator.\n    ...position.filename.split(sysPath.sep).slice(2)\n  )\n\n  let sourceContent\n  try {\n    sourceContent = fs.readFileSync(filename, `utf-8`)\n  } catch (e) {\n    sourceContent = null\n  }\n\n  // We prefer the file path from the stack trace as the error might not be in the\n  // component â€” but if source-maps fail and we just get public/render-page.js as\n  // the file, we fall back on the component filepath as at least the user\n  // will have that.\n  const trueFileName = filename.includes(`render-page`)\n    ? componentPath\n    : filename\n\n  return {\n    filename: slash(sysPath.relative(directory, trueFileName)),\n    sourceContent,\n    message: err.message,\n    stack: stack,\n    line: position.line,\n    column: position.column,\n  }\n}\n\nexports.parseError = parseError\n\nexports.renderHTML = ({\n  path,\n  componentPath,\n  htmlComponentRendererPath,\n  publicDir,\n  isClientOnlyPage = false,\n  error = undefined,\n  directory,\n}) =>\n  new Promise((resolve, reject) => {\n    try {\n      const htmlComponentRenderer = require(htmlComponentRendererPath)\n      if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n        htmlComponentRenderer\n          .default(\n            path,\n            isClientOnlyPage,\n            publicDir,\n            error,\n            (_throwAway, htmlString) => {\n              resolve(htmlString)\n            }\n          )\n          .catch(err => {\n            const error = parseError({ err, directory, componentPath })\n            reject(error)\n          })\n      } else {\n        htmlComponentRenderer.default(path, (_throwAway, htmlString) => {\n          resolve(htmlString)\n        })\n      }\n    } catch (err) {\n      const error = parseError({ err, directory, componentPath })\n      reject(error)\n    }\n  })\n\nexports.deleteModuleCache = htmlComponentRendererPath => {\n  delete require.cache[require.resolve(htmlComponentRendererPath)]\n}\n"],"mappings":"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"}