{"version":3,"file":"develop-proxy.js","names":["noop","startDevelopProxy","input","shouldServeRestartingScreen","proxy","httpProxy","createProxyServer","target","targetPort","changeOrigin","preserveHeaderKeyCase","autoRewrite","ws","on","app","req","res","url","getServices","program","directory","then","services","setHeader","end","JSON","stringify","fs","readFileSync","require","resolve","restartingScreen","web","server","ssl","https","createServer","http","socket","head","listen","proxyPort","host","serveRestartingScreen","serveSite"],"sources":["../../src/utils/develop-proxy.ts"],"sourcesContent":["import http from \"http\"\nimport https from \"https\"\nimport httpProxy from \"http-proxy\"\nimport fs from \"fs-extra\"\nimport { getServices } from \"gatsby-core-utils\"\nimport restartingScreen from \"./restarting-screen\"\nimport { IProgram } from \"../commands/types\"\n\nexport interface IProxyControls {\n  serveRestartingScreen: () => void\n  serveSite: () => void\n  server: https.Server | http.Server\n}\n\nconst noop = (): void => {}\n\nexport const startDevelopProxy = (input: {\n  proxyPort: number\n  targetPort: number\n  program: IProgram\n}): IProxyControls => {\n  let shouldServeRestartingScreen = false\n\n  const proxy = httpProxy.createProxyServer({\n    target: `http://localhost:${input.targetPort}`,\n    changeOrigin: true,\n    preserveHeaderKeyCase: true,\n    autoRewrite: true,\n    ws: true,\n  })\n\n  // Noop on proxy errors, as this throws a bunch of \"Socket hang up\"\n  // ones whenever the page is refreshed\n  proxy.on(`error`, noop)\n\n  const app: http.RequestListener = (req, res): void => {\n    // Add a route at localhost:8000/___services for service discovery\n    if (req.url === `/___services`) {\n      getServices(input.program.directory).then(services => {\n        res.setHeader(`Content-Type`, `application/json`)\n        res.end(JSON.stringify(services))\n      })\n      return\n    }\n\n    if (req.url === `/socket.io/socket.io.js`) {\n      res.setHeader(`Content-Type`, `application/javascript`)\n      res.end(\n        fs.readFileSync(require.resolve(`socket.io-client/dist/socket.io.js`))\n      )\n      return\n    }\n\n    if (\n      shouldServeRestartingScreen ||\n      req.url === `/___debug-restarting-screen`\n    ) {\n      res.end(restartingScreen)\n      return\n    }\n\n    proxy.web(req, res)\n  }\n\n  const server = input.program.ssl\n    ? https.createServer(input.program.ssl, app)\n    : http.createServer(app)\n\n  server.on(`upgrade`, function (req, socket, head) {\n    proxy.ws(req, socket, head)\n  })\n\n  server.listen(input.proxyPort, input.program.host)\n\n  return {\n    server,\n    serveRestartingScreen: (): void => {\n      shouldServeRestartingScreen = true\n    },\n    serveSite: (): void => {\n      shouldServeRestartingScreen = false\n    },\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AASA,MAAMA,IAAI,GAAG,MAAY,CAAE,CAA3B;;AAEO,MAAMC,iBAAiB,GAAIC,KAAD,IAIX;EACpB,IAAIC,2BAA2B,GAAG,KAAlC;;EAEA,MAAMC,KAAK,GAAGC,kBAAA,CAAUC,iBAAV,CAA4B;IACxCC,MAAM,EAAG,oBAAmBL,KAAK,CAACM,UAAW,EADL;IAExCC,YAAY,EAAE,IAF0B;IAGxCC,qBAAqB,EAAE,IAHiB;IAIxCC,WAAW,EAAE,IAJ2B;IAKxCC,EAAE,EAAE;EALoC,CAA5B,CAAd,CAHoB,CAWpB;EACA;;;EACAR,KAAK,CAACS,EAAN,CAAU,OAAV,EAAkBb,IAAlB;;EAEA,MAAMc,GAAyB,GAAG,CAACC,GAAD,EAAMC,GAAN,KAAoB;IACpD;IACA,IAAID,GAAG,CAACE,GAAJ,KAAa,cAAjB,EAAgC;MAC9B,IAAAC,4BAAA,EAAYhB,KAAK,CAACiB,OAAN,CAAcC,SAA1B,EAAqCC,IAArC,CAA0CC,QAAQ,IAAI;QACpDN,GAAG,CAACO,SAAJ,CAAe,cAAf,EAA+B,kBAA/B;QACAP,GAAG,CAACQ,GAAJ,CAAQC,IAAI,CAACC,SAAL,CAAeJ,QAAf,CAAR;MACD,CAHD;MAIA;IACD;;IAED,IAAIP,GAAG,CAACE,GAAJ,KAAa,yBAAjB,EAA2C;MACzCD,GAAG,CAACO,SAAJ,CAAe,cAAf,EAA+B,wBAA/B;MACAP,GAAG,CAACQ,GAAJ,CACEG,gBAAA,CAAGC,YAAH,CAAgBC,OAAO,CAACC,OAAR,CAAiB,oCAAjB,CAAhB,CADF;MAGA;IACD;;IAED,IACE3B,2BAA2B,IAC3BY,GAAG,CAACE,GAAJ,KAAa,6BAFf,EAGE;MACAD,GAAG,CAACQ,GAAJ,CAAQO,yBAAR;MACA;IACD;;IAED3B,KAAK,CAAC4B,GAAN,CAAUjB,GAAV,EAAeC,GAAf;EACD,CA3BD;;EA6BA,MAAMiB,MAAM,GAAG/B,KAAK,CAACiB,OAAN,CAAce,GAAd,GACXC,cAAA,CAAMC,YAAN,CAAmBlC,KAAK,CAACiB,OAAN,CAAce,GAAjC,EAAsCpB,GAAtC,CADW,GAEXuB,aAAA,CAAKD,YAAL,CAAkBtB,GAAlB,CAFJ;EAIAmB,MAAM,CAACpB,EAAP,CAAW,SAAX,EAAqB,UAAUE,GAAV,EAAeuB,MAAf,EAAuBC,IAAvB,EAA6B;IAChDnC,KAAK,CAACQ,EAAN,CAASG,GAAT,EAAcuB,MAAd,EAAsBC,IAAtB;EACD,CAFD;EAIAN,MAAM,CAACO,MAAP,CAActC,KAAK,CAACuC,SAApB,EAA+BvC,KAAK,CAACiB,OAAN,CAAcuB,IAA7C;EAEA,OAAO;IACLT,MADK;IAELU,qBAAqB,EAAE,MAAY;MACjCxC,2BAA2B,GAAG,IAA9B;IACD,CAJI;IAKLyC,SAAS,EAAE,MAAY;MACrBzC,2BAA2B,GAAG,KAA9B;IACD;EAPI,CAAP;AASD,CAnEM"}