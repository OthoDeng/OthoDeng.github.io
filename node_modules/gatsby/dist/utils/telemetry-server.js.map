{"version":3,"file":"telemetry-server.js","names":["setDefaultComponentId","ROUTES","trackEvent","trackCli","trackError","app","express","use","cors","get","_","res","set","send","Object","keys","map","route","join","post","bodyParser","json","req","body","Array","isArray","status","error","err","console","message","startTelemetryServer","port","startBackgroundUpdate","listen"],"sources":["../../src/utils/telemetry-server.ts"],"sourcesContent":["/*\n * This exposes gatsby-telemetry functions over HTTP. POST an array of arguments to the path.\n * For example:\n * curl -X POST http://localhost:2345/setVersion\n *   -H \"Content-Type: application/json\"\n *   -d \"[\\\"1.2.3\\\"]\"\n */\nimport express from \"express\"\nimport bodyParser from \"body-parser\"\nimport cors from \"cors\"\nimport {\n  setDefaultComponentId,\n  trackCli,\n  trackError,\n  startBackgroundUpdate,\n} from \"gatsby-telemetry\"\n\nsetDefaultComponentId(`gatsby-admin`)\n\n// These routes will exist in the API at the keys, e.g.\n// http://localhost:1234/trackEvent\nconst ROUTES = {\n  trackEvent: trackCli,\n  trackError,\n}\n\nconst app = express()\n\napp.use(cors())\n\n// Overview over all possible routes at /\napp.get(`/`, (_, res) => {\n  res.set(`Content-Type`, `text/html`)\n  res.send(\n    `<ul>\n      ${Object.keys(ROUTES)\n        .map(route => `<li><a href=\"/${route}\">/${route}</a></li>`)\n        .join(`\\n`)}\n    </ul>`\n  )\n})\n\nObject.keys(ROUTES).map(route => {\n  app.post(`/${route}`, bodyParser.json(), (req, res) => {\n    if (!req.body || !Array.isArray(req.body)) {\n      res.json({\n        status: `error`,\n        error: `Please provide a body array with the arguments for the function.`,\n      })\n      return\n    }\n\n    try {\n      ROUTES[route](...req.body)\n    } catch (err) {\n      console.error(err)\n      res.json({ status: `error`, error: err.message })\n      return\n    }\n\n    res.json({ status: `success` })\n  })\n})\n\nexport default function startTelemetryServer(port: number): void {\n  startBackgroundUpdate()\n  app.listen(port)\n}\n"],"mappings":";;;;;;;AAOA;;AACA;;AACA;;AACA;;AAVA;AACA;AACA;AACA;AACA;AACA;AACA;AAWA,IAAAA,sCAAA,EAAuB,cAAvB,E,CAEA;AACA;;AACA,MAAMC,MAAM,GAAG;EACbC,UAAU,EAAEC,yBADC;EAEbC,UAAU,EAAVA;AAFa,CAAf;AAKA,MAAMC,GAAG,GAAG,IAAAC,gBAAA,GAAZ;AAEAD,GAAG,CAACE,GAAJ,CAAQ,IAAAC,aAAA,GAAR,E,CAEA;;AACAH,GAAG,CAACI,GAAJ,CAAS,GAAT,EAAa,CAACC,CAAD,EAAIC,GAAJ,KAAY;EACvBA,GAAG,CAACC,GAAJ,CAAS,cAAT,EAAyB,WAAzB;EACAD,GAAG,CAACE,IAAJ,CACG;AACL,QAAQC,MAAM,CAACC,IAAP,CAAYd,MAAZ,EACCe,GADD,CACKC,KAAK,IAAK,iBAAgBA,KAAM,MAAKA,KAAM,WADhD,EAECC,IAFD,CAEO,IAFP,CAEY;AACpB,UALE;AAOD,CATD;AAWAJ,MAAM,CAACC,IAAP,CAAYd,MAAZ,EAAoBe,GAApB,CAAwBC,KAAK,IAAI;EAC/BZ,GAAG,CAACc,IAAJ,CAAU,IAAGF,KAAM,EAAnB,EAAsBG,mBAAA,CAAWC,IAAX,EAAtB,EAAyC,CAACC,GAAD,EAAMX,GAAN,KAAc;IACrD,IAAI,CAACW,GAAG,CAACC,IAAL,IAAa,CAACC,KAAK,CAACC,OAAN,CAAcH,GAAG,CAACC,IAAlB,CAAlB,EAA2C;MACzCZ,GAAG,CAACU,IAAJ,CAAS;QACPK,MAAM,EAAG,OADF;QAEPC,KAAK,EAAG;MAFD,CAAT;MAIA;IACD;;IAED,IAAI;MACF1B,MAAM,CAACgB,KAAD,CAAN,CAAc,GAAGK,GAAG,CAACC,IAArB;IACD,CAFD,CAEE,OAAOK,GAAP,EAAY;MACZC,OAAO,CAACF,KAAR,CAAcC,GAAd;MACAjB,GAAG,CAACU,IAAJ,CAAS;QAAEK,MAAM,EAAG,OAAX;QAAmBC,KAAK,EAAEC,GAAG,CAACE;MAA9B,CAAT;MACA;IACD;;IAEDnB,GAAG,CAACU,IAAJ,CAAS;MAAEK,MAAM,EAAG;IAAX,CAAT;EACD,CAlBD;AAmBD,CApBD;;AAsBe,SAASK,oBAAT,CAA8BC,IAA9B,EAAkD;EAC/D,IAAAC,sCAAA;EACA5B,GAAG,CAAC6B,MAAJ,CAAWF,IAAX;AACD"}