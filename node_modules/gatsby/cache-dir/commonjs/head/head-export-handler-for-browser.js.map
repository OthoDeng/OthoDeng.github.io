{"version":3,"file":"head-export-handler-for-browser.js","names":["hiddenRoot","document","createElement","removePrevHeadElements","prevHeadNodes","querySelectorAll","node","parentNode","removeChild","onHeadRendered","validHeadNodes","seenIds","Map","childNodes","nodeName","toLowerCase","id","attributes","value","VALID_NODE_NAMES","includes","warnForInvalidTags","clonedNode","cloneNode","setAttribute","script","attr","name","innerHTML","has","push","set","length","indexOfPreviouslyInsertedNode","get","existingHeadElements","head","append","newHeadNodes","diffNodes","oldNodes","newNodes","onStale","onNew","process","env","BUILD_STAGE","observer","MutationObserver","observe","childList","characterData","subtree","headHandlerForBrowser","pageComponent","staticQueryResults","pageComponentProps","useEffect","Head","headExportValidator","render","reactDOMUtils","filterHeadProps"],"sources":["../../head/head-export-handler-for-browser.js"],"sourcesContent":["import React from \"react\"\nimport { useEffect } from \"react\"\nimport { StaticQueryContext } from \"gatsby\"\nimport { LocationProvider } from \"@gatsbyjs/reach-router\"\nimport { reactDOMUtils } from \"../react-dom-utils\"\nimport { FireCallbackInEffect } from \"./components/fire-callback-in-effect\"\nimport { VALID_NODE_NAMES } from \"./constants\"\nimport {\n  headExportValidator,\n  filterHeadProps,\n  warnForInvalidTags,\n  diffNodes,\n} from \"./utils\"\n\nconst hiddenRoot = document.createElement(`div`)\n\nconst removePrevHeadElements = () => {\n  const prevHeadNodes = document.querySelectorAll(`[data-gatsby-head]`)\n\n  for (const node of prevHeadNodes) {\n    node.parentNode.removeChild(node)\n  }\n}\n\nconst onHeadRendered = () => {\n  const validHeadNodes = []\n\n  const seenIds = new Map()\n  for (const node of hiddenRoot.childNodes) {\n    const nodeName = node.nodeName.toLowerCase()\n    const id = node.attributes?.id?.value\n\n    if (!VALID_NODE_NAMES.includes(nodeName)) {\n      warnForInvalidTags(nodeName)\n    } else {\n      let clonedNode = node.cloneNode(true)\n      clonedNode.setAttribute(`data-gatsby-head`, true)\n\n      // Create an element for scripts to make script work\n      if (clonedNode.nodeName.toLowerCase() === `script`) {\n        const script = document.createElement(`script`)\n        for (const attr of clonedNode.attributes) {\n          script.setAttribute(attr.name, attr.value)\n        }\n        script.innerHTML = clonedNode.innerHTML\n        clonedNode = script\n      }\n\n      if (id) {\n        if (!seenIds.has(id)) {\n          validHeadNodes.push(clonedNode)\n          seenIds.set(id, validHeadNodes.length - 1)\n        } else {\n          const indexOfPreviouslyInsertedNode = seenIds.get(id)\n          validHeadNodes[indexOfPreviouslyInsertedNode].parentNode?.removeChild(\n            validHeadNodes[indexOfPreviouslyInsertedNode]\n          )\n          validHeadNodes[indexOfPreviouslyInsertedNode] = clonedNode\n        }\n      } else {\n        validHeadNodes.push(clonedNode)\n      }\n    }\n  }\n\n  const existingHeadElements = document.querySelectorAll(`[data-gatsby-head]`)\n\n  if (existingHeadElements.length === 0) {\n    document.head.append(...validHeadNodes)\n    return\n  }\n\n  const newHeadNodes = []\n  diffNodes({\n    oldNodes: existingHeadElements,\n    newNodes: validHeadNodes,\n    onStale: node => node.parentNode.removeChild(node),\n    onNew: node => newHeadNodes.push(node),\n  })\n\n  document.head.append(...newHeadNodes)\n}\n\nif (process.env.BUILD_STAGE === `develop`) {\n  // We set up observer to be able to regenerate <head> after react-refresh\n  // updates our hidden element.\n  const observer = new MutationObserver(onHeadRendered)\n  observer.observe(hiddenRoot, {\n    attributes: true,\n    childList: true,\n    characterData: true,\n    subtree: true,\n  })\n}\n\nexport function headHandlerForBrowser({\n  pageComponent,\n  staticQueryResults,\n  pageComponentProps,\n}) {\n  useEffect(() => {\n    if (pageComponent?.Head) {\n      headExportValidator(pageComponent.Head)\n\n      const { render } = reactDOMUtils()\n\n      const Head = pageComponent.Head\n\n      render(\n        // just a hack to call the callback after react has done first render\n        // Note: In dev, we call onHeadRendered twice( in FireCallbackInEffect and after mutualution observer dectects initail render into hiddenRoot) this is for hot reloading\n        // In Prod we only call onHeadRendered in FireCallbackInEffect to render to head\n        <FireCallbackInEffect callback={onHeadRendered}>\n          <StaticQueryContext.Provider value={staticQueryResults}>\n            <LocationProvider>\n              <Head {...filterHeadProps(pageComponentProps)} />\n            </LocationProvider>\n          </StaticQueryContext.Provider>\n        </FireCallbackInEffect>,\n        hiddenRoot\n      )\n    }\n\n    return () => {\n      removePrevHeadElements()\n    }\n  })\n}\n"],"mappings":"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"}