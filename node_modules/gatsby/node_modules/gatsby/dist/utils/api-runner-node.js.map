{"version":3,"sources":["../../src/utils/api-runner-node.js"],"names":["Promise","require","_","chalk","bindActionCreators","origBindActionCreators","memoize","tracer","globalTracer","reporter","stackTrace","codeFrameColumns","fs","getCache","createContentDigest","emitter","store","getNodes","getNode","getNodesByType","hasNodeChanged","getNodeAndSavePathDependency","getPublicPath","getNonGatsbyCodeFrameFormatted","trackBuildError","decorateEvent","loadNodeContent","process","env","BLUEBIRD_DEBUG","BLUEBIRD_LONG_STACK_TRACES","config","longStackTraces","boundPluginActionCreators","doubleBind","boundActionCreators","api","plugin","actionOptions","traceId","deferNodeMutation","defer","actionKey","name","keys","Object","doubleBoundActionCreators","i","length","key","boundActionCreator","args","undefined","initAPICallTracing","parentSpan","startSpan","spanName","spanArgs","defaultSpanArgs","childOf","merge","deferredAction","type","resolve","emit","payload","NODE_MUTATION_ACTIONS","deferActions","actions","deferred","forEach","action","getLocalReporter","activity","panicOnBuild","bind","extendErrorIdWithPluginName","pluginName","errorMeta","id","isPrefixed","includes","getErrorMapWithPluginName","errorMap","entries","reduce","memo","val","extendLocalReporterToCatchPluginErrors","runningActivities","setErrorMap","error","panic","addPluginNameToErrorMeta","context","sourceMessage","errorMetaWithPluginName","activityTimer","apply","originalStart","start","originalEnd","end","add","delete","createProgress","originalDone","done","getUninitializedCache","message","get","Error","set","pluginNodeCache","Map","availableActionsCache","publicPath","runAPI","gatsbyNode","spanOptions","pluginSpan","setTag","publicActions","restrictedActionsAvailableInAPI","availableActions","has","dispatch","program","getState","pathPrefix","prefixPaths","namespacedCreateNodeId","tracing","cache","apiFinished","alreadyDisplayed","createPageAction","createPage","warning","stripIndent","bold","possiblyCodeFrame","push","warn","join","localReporter","Set","extendedLocalReporter","endInProgressActivitiesCreatedByThisRun","apiCallArgs","basePath","createNodeId","schema","buildObjectType","buildUnionType","buildInterfaceType","buildInputObjectType","buildEnumType","buildScalarType","pluginOptions","fromCallback","callback","cb","err","finish","e","version","apisRunningById","apisRunningByTraceId","waitingForCasacadeToFinish","module","exports","pluginSource","traceTags","waitForCascadingActions","apiSpanArgs","apiSpan","value","plugins","flattenedPlugins","implementingPlugins","filter","nodeAPIs","apiRunInstance","span","startTime","Date","toJSON","node","internal","contentDigest","filename","page","path","argsJson","JSON","stringify","omit","size","currentCount","stopQueuedApiRuns","onAPIRunComplete","actionHandler","on","off","apiRunPromiseOptions","runPromise","GATSBY_EXPERIMENTAL_PARALLEL_SOURCING","map","concurrency","mapSeries","unstable_shouldOnCreateNode","catch","file","parse","find","test","fileName","codeFrame","structuredError","lineNumber","line","columnNumber","column","code","readFileSync","encoding","highlightCode","_e","location","filePath","then","results","result","isEmpty","instance","apisByTraceIdCount"],"mappings":"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","sourcesContent":["const Promise = require(`bluebird`)\nconst _ = require(`lodash`)\nconst chalk = require(`chalk`)\nconst { bindActionCreators: origBindActionCreators } = require(`redux`)\nconst memoize = require(`memoizee`)\n\nconst bindActionCreators = memoize(origBindActionCreators)\n\nconst tracer = require(`opentracing`).globalTracer()\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst stackTrace = require(`stack-trace`)\nconst { codeFrameColumns } = require(`@babel/code-frame`)\nconst fs = require(`fs-extra`)\nconst { getCache } = require(`./get-cache`)\nimport { createNodeId } from \"./create-node-id\"\nconst { createContentDigest } = require(`gatsby-core-utils`)\nimport {\n  buildObjectType,\n  buildUnionType,\n  buildInterfaceType,\n  buildInputObjectType,\n  buildEnumType,\n  buildScalarType,\n} from \"../schema/types/type-builders\"\nconst { emitter, store } = require(`../redux`)\nconst {\n  getNodes,\n  getNode,\n  getNodesByType,\n  hasNodeChanged,\n  getNodeAndSavePathDependency,\n} = require(`../redux/nodes`)\nconst { getPublicPath } = require(`./get-public-path`)\nconst { getNonGatsbyCodeFrameFormatted } = require(`./stack-trace-utils`)\nconst { trackBuildError, decorateEvent } = require(`gatsby-telemetry`)\nimport errorParser from \"./api-runner-error-parser\"\nconst { loadNodeContent } = require(`../db/nodes`)\n\nif (!process.env.BLUEBIRD_DEBUG && !process.env.BLUEBIRD_LONG_STACK_TRACES) {\n  // Unless specified - disable longStackTraces\n  // as this have severe perf penalty ( http://bluebirdjs.com/docs/api/promise.longstacktraces.html )\n  // This is mainly for `gatsby develop` due to NODE_ENV being set to development\n  // which cause bluebird to enable longStackTraces\n  // `gatsby build` (with NODE_ENV=production) already doesn't enable longStackTraces\n  Promise.config({ longStackTraces: false })\n}\n\n// Bind action creators per plugin so we can auto-add\n// metadata to actions they create.\nconst boundPluginActionCreators = {}\nconst doubleBind = (boundActionCreators, api, plugin, actionOptions) => {\n  const { traceId, deferNodeMutation } = actionOptions\n  const defer = deferNodeMutation ? `defer-node-mutation` : ``\n  const actionKey = plugin.name + api + traceId + defer\n  if (boundPluginActionCreators[actionKey]) {\n    return boundPluginActionCreators[actionKey]\n  } else {\n    const keys = Object.keys(boundActionCreators)\n    const doubleBoundActionCreators = {}\n    for (let i = 0; i < keys.length; i++) {\n      const key = keys[i]\n      const boundActionCreator = boundActionCreators[key]\n      if (typeof boundActionCreator === `function`) {\n        doubleBoundActionCreators[key] = (...args) => {\n          // Let action callers override who the plugin is. Shouldn't be\n          // used that often.\n          if (args.length === 1) {\n            return boundActionCreator(args[0], plugin, actionOptions)\n          } else if (args.length === 2) {\n            return boundActionCreator(args[0], args[1], actionOptions)\n          }\n          return undefined\n        }\n      }\n    }\n    boundPluginActionCreators[actionKey] = doubleBoundActionCreators\n    return doubleBoundActionCreators\n  }\n}\n\nconst initAPICallTracing = parentSpan => {\n  const startSpan = (spanName, spanArgs = {}) => {\n    const defaultSpanArgs = { childOf: parentSpan }\n\n    return tracer.startSpan(spanName, _.merge(defaultSpanArgs, spanArgs))\n  }\n\n  return {\n    tracer,\n    parentSpan,\n    startSpan,\n  }\n}\n\nconst deferredAction = type => (...args) => {\n  // Regular createNode returns a Promise, but when deferred we need\n  // to wrap it in another which we resolve when it's actually called\n  if (type === `createNode`) {\n    return new Promise(resolve => {\n      emitter.emit(`ENQUEUE_NODE_MUTATION`, {\n        type,\n        payload: args,\n        resolve,\n      })\n    })\n  }\n  return emitter.emit(`ENQUEUE_NODE_MUTATION`, {\n    type,\n    payload: args,\n  })\n}\n\nconst NODE_MUTATION_ACTIONS = [\n  `createNode`,\n  `deleteNode`,\n  `deleteNodes`,\n  `touchNode`,\n  `createParentChildLink`,\n  `createNodeField`,\n]\n\nconst deferActions = actions => {\n  const deferred = { ...actions }\n  NODE_MUTATION_ACTIONS.forEach(action => {\n    deferred[action] = deferredAction(action)\n  })\n  return deferred\n}\n\n/**\n * Create a local reporter\n * Used to override reporter methods with activity methods\n */\nfunction getLocalReporter({ activity, reporter }) {\n  // If we have an activity, bind panicOnBuild to the activities method to\n  // join them\n  if (activity) {\n    return { ...reporter, panicOnBuild: activity.panicOnBuild.bind(activity) }\n  }\n\n  return reporter\n}\n\nfunction extendErrorIdWithPluginName(pluginName, errorMeta) {\n  const id = errorMeta?.id\n  if (id) {\n    const isPrefixed = id.includes(`${pluginName}_`)\n    if (!isPrefixed) {\n      return {\n        ...errorMeta,\n        id: `${pluginName}_${id}`,\n      }\n    }\n  }\n\n  return errorMeta\n}\n\nfunction getErrorMapWithPluginName(pluginName, errorMap) {\n  const entries = Object.entries(errorMap)\n\n  return entries.reduce((memo, [key, val]) => {\n    memo[`${pluginName}_${key}`] = val\n\n    return memo\n  }, {})\n}\n\nfunction extendLocalReporterToCatchPluginErrors({\n  reporter,\n  pluginName,\n  runningActivities,\n}) {\n  let setErrorMap\n\n  let error = reporter.error\n  let panic = reporter.panic\n  let panicOnBuild = reporter.panicOnBuild\n\n  const addPluginNameToErrorMeta = (errorMeta, pluginName) =>\n    typeof errorMeta === `string`\n      ? {\n          context: {\n            sourceMessage: errorMeta,\n          },\n          pluginName,\n        }\n      : {\n          ...errorMeta,\n          pluginName,\n        }\n\n  if (pluginName && reporter?.setErrorMap) {\n    setErrorMap = errorMap =>\n      reporter.setErrorMap(getErrorMapWithPluginName(pluginName, errorMap))\n\n    error = (errorMeta, error) => {\n      const errorMetaWithPluginName = addPluginNameToErrorMeta(\n        errorMeta,\n        pluginName\n      )\n      reporter.error(\n        extendErrorIdWithPluginName(pluginName, errorMetaWithPluginName),\n        error\n      )\n    }\n\n    panic = (errorMeta, error) => {\n      const errorMetaWithPluginName = addPluginNameToErrorMeta(\n        errorMeta,\n        pluginName\n      )\n      reporter.panic(\n        extendErrorIdWithPluginName(pluginName, errorMetaWithPluginName),\n        error\n      )\n    }\n\n    panicOnBuild = (errorMeta, error) => {\n      const errorMetaWithPluginName = addPluginNameToErrorMeta(\n        errorMeta,\n        pluginName\n      )\n      reporter.panicOnBuild(\n        extendErrorIdWithPluginName(pluginName, errorMetaWithPluginName),\n        error\n      )\n    }\n  }\n\n  return {\n    ...reporter,\n    setErrorMap,\n    error,\n    panic,\n    panicOnBuild,\n    activityTimer: (...args) => {\n      const activity = reporter.activityTimer.apply(reporter, args)\n\n      const originalStart = activity.start\n      const originalEnd = activity.end\n\n      activity.start = () => {\n        originalStart.apply(activity)\n        runningActivities.add(activity)\n      }\n\n      activity.end = () => {\n        originalEnd.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      return activity\n    },\n\n    createProgress: (...args) => {\n      const activity = reporter.createProgress.apply(reporter, args)\n\n      const originalStart = activity.start\n      const originalEnd = activity.end\n      const originalDone = activity.done\n\n      activity.start = () => {\n        originalStart.apply(activity)\n        runningActivities.add(activity)\n      }\n\n      activity.end = () => {\n        originalEnd.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      activity.done = () => {\n        originalDone.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      return activity\n    },\n  }\n}\n\nconst getUninitializedCache = plugin => {\n  const message =\n    `Usage of \"cache\" instance in \"onPreInit\" API is not supported as ` +\n    `this API runs before cache initialization` +\n    (plugin && plugin !== `default-site-plugin` ? ` (called in ${plugin})` : ``)\n\n  return {\n    // GatsbyCache\n    async get() {\n      throw new Error(message)\n    },\n    async set() {\n      throw new Error(message)\n    },\n  }\n}\n\nconst pluginNodeCache = new Map()\n\nconst availableActionsCache = new Map()\nlet publicPath\nconst runAPI = async (plugin, api, args, activity) => {\n  let gatsbyNode = pluginNodeCache.get(plugin.name)\n  if (!gatsbyNode) {\n    gatsbyNode = require(`${plugin.resolve}/gatsby-node`)\n    pluginNodeCache.set(plugin.name, gatsbyNode)\n  }\n\n  if (gatsbyNode[api]) {\n    const parentSpan = args && args.parentSpan\n    const spanOptions = parentSpan ? { childOf: parentSpan } : {}\n    const pluginSpan = tracer.startSpan(`run-plugin`, spanOptions)\n\n    pluginSpan.setTag(`api`, api)\n    pluginSpan.setTag(`plugin`, plugin.name)\n    const {\n      publicActions,\n      restrictedActionsAvailableInAPI,\n    } = require(`../redux/actions`)\n\n    let availableActions\n    if (availableActionsCache.has(api)) {\n      availableActions = availableActionsCache.get(api)\n    } else {\n      availableActions = {\n        ...publicActions,\n        ...(restrictedActionsAvailableInAPI[api] || {}),\n      }\n\n      availableActionsCache.set(api, availableActions)\n    }\n\n    let boundActionCreators = bindActionCreators(\n      availableActions,\n      store.dispatch\n    )\n\n    if (args.deferNodeMutation) {\n      boundActionCreators = deferActions(boundActionCreators)\n    }\n\n    const doubleBoundActionCreators = doubleBind(\n      boundActionCreators,\n      api,\n      plugin,\n      { ...args, parentSpan: pluginSpan, activity }\n    )\n\n    const { config, program } = store.getState()\n\n    const pathPrefix = (program.prefixPaths && config.pathPrefix) || ``\n\n    if (typeof publicPath === `undefined`) {\n      publicPath = getPublicPath({ ...config, ...program }, ``)\n    }\n\n    const namespacedCreateNodeId = id => createNodeId(id, plugin.name)\n\n    const tracing = initAPICallTracing(pluginSpan)\n\n    // See https://github.com/gatsbyjs/gatsby/issues/11369\n    const cache =\n      api === `onPreInit`\n        ? getUninitializedCache(plugin.name)\n        : getCache(plugin.name)\n\n    // Ideally this would be more abstracted and applied to more situations, but right now\n    // this can be potentially breaking so targeting `createPages` API and `createPage` action\n    let actions = doubleBoundActionCreators\n    let apiFinished = false\n    if (api === `createPages`) {\n      let alreadyDisplayed = false\n      const createPageAction = actions.createPage\n      // create new actions object with wrapped createPage action\n      // doubleBoundActionCreators is memoized, so we can't just\n      // reassign createPage field as this would cause this extra logic\n      // to be used in subsequent APIs and we only want to target this `createPages` call.\n      actions = {\n        ...actions,\n        createPage: (...args) => {\n          createPageAction(...args)\n          if (apiFinished && !alreadyDisplayed) {\n            const warning = [\n              reporter.stripIndent(`\n              Action ${chalk.bold(\n                `createPage`\n              )} was called outside of its expected asynchronous lifecycle ${chalk.bold(\n                `createPages`\n              )} in ${chalk.bold(plugin.name)}.\n              Ensure that you return a Promise from ${chalk.bold(\n                `createPages`\n              )} and are awaiting any asynchronous method invocations (like ${chalk.bold(\n                `graphql`\n              )} or http requests).\n              For more info and debugging tips: see ${chalk.bold(\n                `https://gatsby.dev/sync-actions`\n              )}\n            `),\n            ]\n\n            const possiblyCodeFrame = getNonGatsbyCodeFrameFormatted()\n            if (possiblyCodeFrame) {\n              warning.push(possiblyCodeFrame)\n            }\n\n            reporter.warn(warning.join(`\\n\\n`))\n            alreadyDisplayed = true\n          }\n        },\n      }\n    }\n\n    const localReporter = getLocalReporter({ activity, reporter })\n\n    const runningActivities = new Set()\n\n    const extendedLocalReporter = extendLocalReporterToCatchPluginErrors({\n      reporter: localReporter,\n      pluginName: plugin.name,\n      runningActivities,\n    })\n\n    const endInProgressActivitiesCreatedByThisRun = () => {\n      runningActivities.forEach(activity => activity.end())\n    }\n\n    const apiCallArgs = [\n      {\n        ...args,\n        basePath: pathPrefix,\n        pathPrefix: publicPath,\n        boundActionCreators: actions,\n        actions,\n        loadNodeContent,\n        store,\n        emitter,\n        getCache,\n        getNodes,\n        getNode,\n        getNodesByType,\n        hasNodeChanged,\n        reporter: extendedLocalReporter,\n        getNodeAndSavePathDependency,\n        cache,\n        createNodeId: namespacedCreateNodeId,\n        createContentDigest,\n        tracing,\n        schema: {\n          buildObjectType,\n          buildUnionType,\n          buildInterfaceType,\n          buildInputObjectType,\n          buildEnumType,\n          buildScalarType,\n        },\n      },\n      plugin.pluginOptions,\n    ]\n\n    // If the plugin is using a callback use that otherwise\n    // expect a Promise to be returned.\n    if (gatsbyNode[api].length === 3) {\n      return Promise.fromCallback(callback => {\n        const cb = (err, val) => {\n          pluginSpan.finish()\n          apiFinished = true\n          endInProgressActivitiesCreatedByThisRun()\n          callback(err, val)\n        }\n\n        try {\n          gatsbyNode[api](...apiCallArgs, cb)\n        } catch (e) {\n          trackBuildError(api, {\n            error: e,\n            pluginName: `${plugin.name}@${plugin.version}`,\n          })\n          throw e\n        }\n      })\n    } else {\n      try {\n        return await gatsbyNode[api](...apiCallArgs)\n      } finally {\n        pluginSpan.finish()\n        apiFinished = true\n        endInProgressActivitiesCreatedByThisRun()\n      }\n    }\n  }\n\n  return null\n}\n\nconst apisRunningById = new Map()\nconst apisRunningByTraceId = new Map()\nlet waitingForCasacadeToFinish = []\n\nmodule.exports = async (api, args = {}, { pluginSource, activity } = {}) =>\n  new Promise(resolve => {\n    const { parentSpan, traceId, traceTags, waitForCascadingActions } = args\n    const apiSpanArgs = parentSpan ? { childOf: parentSpan } : {}\n    const apiSpan = tracer.startSpan(`run-api`, apiSpanArgs)\n\n    apiSpan.setTag(`api`, api)\n    _.forEach(traceTags, (value, key) => {\n      apiSpan.setTag(key, value)\n    })\n\n    const plugins = store.getState().flattenedPlugins\n\n    // Get the list of plugins that implement this API.\n    // Also: Break infinite loops. Sometimes a plugin will implement an API and\n    // call an action which will trigger the same API being called.\n    // `onCreatePage` is the only example right now. In these cases, we should\n    // avoid calling the originating plugin again.\n    let implementingPlugins = plugins.filter(\n      plugin => plugin.nodeAPIs.includes(api) && plugin.name !== pluginSource\n    )\n\n    if (api === `sourceNodes` && args.pluginName) {\n      implementingPlugins = implementingPlugins.filter(\n        plugin => plugin.name === args.pluginName\n      )\n    }\n\n    const apiRunInstance = {\n      api,\n      args,\n      pluginSource,\n      resolve,\n      span: apiSpan,\n      startTime: new Date().toJSON(),\n      traceId,\n    }\n\n    // Generate IDs for api runs. Most IDs we generate from the args\n    // but some API calls can have very large argument objects so we\n    // have special ways of generating IDs for those to avoid stringifying\n    // large objects.\n    let id\n    if (api === `setFieldsOnGraphQLNodeType`) {\n      id = `${api}${apiRunInstance.startTime}${args.type.name}${traceId}`\n    } else if (api === `onCreateNode`) {\n      id = `${api}${apiRunInstance.startTime}${args.node.internal.contentDigest}${traceId}`\n    } else if (api === `preprocessSource`) {\n      id = `${api}${apiRunInstance.startTime}${args.filename}${traceId}`\n    } else if (api === `onCreatePage`) {\n      id = `${api}${apiRunInstance.startTime}${args.page.path}${traceId}`\n    } else {\n      // When tracing is turned on, the `args` object will have a\n      // `parentSpan` field that can be quite large. So we omit it\n      // before calling stringify\n      const argsJson = JSON.stringify(_.omit(args, `parentSpan`))\n      id = `${api}|${apiRunInstance.startTime}|${apiRunInstance.traceId}|${argsJson}`\n    }\n    apiRunInstance.id = id\n\n    if (waitForCascadingActions) {\n      waitingForCasacadeToFinish.push(apiRunInstance)\n    }\n\n    if (apisRunningById.size === 0) {\n      emitter.emit(`API_RUNNING_START`)\n    }\n\n    apisRunningById.set(apiRunInstance.id, apiRunInstance)\n    if (apisRunningByTraceId.has(apiRunInstance.traceId)) {\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount + 1)\n    } else {\n      apisRunningByTraceId.set(apiRunInstance.traceId, 1)\n    }\n\n    let stopQueuedApiRuns = false\n    let onAPIRunComplete = null\n    if (api === `onCreatePage`) {\n      const path = args.page.path\n      const actionHandler = action => {\n        if (action.payload.path === path) {\n          stopQueuedApiRuns = true\n        }\n      }\n      emitter.on(`DELETE_PAGE`, actionHandler)\n      onAPIRunComplete = () => {\n        emitter.off(`DELETE_PAGE`, actionHandler)\n      }\n    }\n\n    let apiRunPromiseOptions = {}\n    let runPromise\n    if (\n      api === `sourceNodes` &&\n      process.env.GATSBY_EXPERIMENTAL_PARALLEL_SOURCING\n    ) {\n      runPromise = Promise.map\n      apiRunPromiseOptions.concurrency = 20\n    } else {\n      runPromise = Promise.mapSeries\n      apiRunPromiseOptions = undefined\n    }\n\n    runPromise(\n      implementingPlugins,\n      plugin => {\n        if (stopQueuedApiRuns) {\n          return null\n        }\n\n        let gatsbyNode = pluginNodeCache.get(plugin.name)\n        if (!gatsbyNode) {\n          gatsbyNode = require(`${plugin.resolve}/gatsby-node`)\n          pluginNodeCache.set(plugin.name, gatsbyNode)\n        }\n\n        const pluginName =\n          plugin.name === `default-site-plugin` ? `gatsby-node.js` : plugin.name\n\n        // TODO: rethink createNode API to handle this better\n        if (\n          api === `onCreateNode` &&\n          gatsbyNode?.unstable_shouldOnCreateNode && // Don't bail if this api is not exported\n          !gatsbyNode.unstable_shouldOnCreateNode(\n            { node: args.node },\n            plugin.pluginOptions\n          )\n        ) {\n          // Do not try to schedule an async event for this node for this plugin\n          return null\n        }\n\n        return new Promise(resolve => {\n          resolve(\n            runAPI(plugin, api, { ...args, parentSpan: apiSpan }, activity)\n          )\n        }).catch(err => {\n          decorateEvent(`BUILD_PANIC`, {\n            pluginName: `${plugin.name}@${plugin.version}`,\n          })\n\n          const localReporter = getLocalReporter({ activity, reporter })\n\n          const file = stackTrace\n            .parse(err)\n            .find(file => /gatsby-node/.test(file.fileName))\n\n          let codeFrame = ``\n          const structuredError = errorParser({ err })\n\n          if (file) {\n            const { fileName, lineNumber: line, columnNumber: column } = file\n\n            try {\n              const code = fs.readFileSync(fileName, { encoding: `utf-8` })\n              codeFrame = codeFrameColumns(\n                code,\n                {\n                  start: {\n                    line,\n                    column,\n                  },\n                },\n                {\n                  highlightCode: true,\n                }\n              )\n            } catch (_e) {\n              // sometimes stack trace point to not existing file\n              // particularly when file is transpiled and path actually changes\n              // (like pointing to not existing `src` dir or original typescript file)\n            }\n\n            structuredError.location = {\n              start: { line: line, column: column },\n            }\n            structuredError.filePath = fileName\n          }\n\n          structuredError.context = {\n            ...structuredError.context,\n            pluginName,\n            api,\n            codeFrame,\n          }\n\n          localReporter.panicOnBuild(structuredError)\n\n          return null\n        })\n      },\n      apiRunPromiseOptions\n    ).then(results => {\n      if (onAPIRunComplete) {\n        onAPIRunComplete()\n      }\n      // Remove runner instance\n      apisRunningById.delete(apiRunInstance.id)\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount - 1)\n\n      if (apisRunningById.size === 0) {\n        emitter.emit(`API_RUNNING_QUEUE_EMPTY`)\n      }\n\n      // Filter empty results\n      apiRunInstance.results = results.filter(result => !_.isEmpty(result))\n\n      // Filter out empty responses and return if the\n      // api caller isn't waiting for cascading actions to finish.\n      if (!waitForCascadingActions) {\n        apiSpan.finish()\n        resolve(apiRunInstance.results)\n      }\n\n      // Check if any of our waiters are done.\n      waitingForCasacadeToFinish = waitingForCasacadeToFinish.filter(\n        instance => {\n          // If none of its trace IDs are running, it's done.\n          const apisByTraceIdCount = apisRunningByTraceId.get(instance.traceId)\n          if (apisByTraceIdCount === 0) {\n            instance.span.finish()\n            instance.resolve(instance.results)\n            return false\n          } else {\n            return true\n          }\n        }\n      )\n      return\n    })\n  })\n"],"file":"api-runner-node.js"}