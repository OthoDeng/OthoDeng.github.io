{"version":3,"file":"run-steps.js","names":["runSteps","steps","helpers","pluginOptions","apiName","step","timeBuildSteps","debug","timeStep","includes","name","activity","reporter","activityTimer","formatLogMessage","useVerboseStyle","start","Array","isArray","end","e","sharedError","invokeAndCleanupLeftoverPreviewCallbacks","status","context","error","console","panic","id","CODES","SourcePluginCodeError","sourceMessage","findApiName","initialApiNameString","potentialApiNames","split","isGatsbyNodeLifecycleSupported","require","join","Error","runApiSteps"],"sources":["../../src/utils/run-steps.ts"],"sourcesContent":["import { GatsbyNodeApiHelpers, GatsbyReporter } from \"./gatsby-types\"\nimport { IPluginOptions } from \"~/models/gatsby-api\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport { invokeAndCleanupLeftoverPreviewCallbacks } from \"../steps/preview/cleanup\"\nimport { CODES } from \"./report\"\n\nexport type Step = (\n  helpers?: GatsbyNodeApiHelpers,\n  pluginOptions?: IPluginOptions\n) => Promise<void> | void\n\nexport type ActivityTimer = ReturnType<GatsbyReporter[\"activityTimer\"]>\n\nconst runSteps = async (\n  steps: Array<Step>,\n  helpers: GatsbyNodeApiHelpers,\n  pluginOptions: IPluginOptions,\n  apiName: string\n): Promise<void> => {\n  for (const step of steps) {\n    try {\n      const { timeBuildSteps } = pluginOptions?.debug ?? {}\n      const timeStep =\n        typeof timeBuildSteps === `boolean`\n          ? timeBuildSteps\n          : timeBuildSteps?.includes(step.name) ||\n            timeBuildSteps?.includes(apiName)\n\n      let activity: ActivityTimer\n\n      if (timeStep) {\n        activity = helpers.reporter.activityTimer(\n          formatLogMessage(`step -${!apiName ? `-` : ``}> ${step.name}`, {\n            useVerboseStyle: true,\n          })\n        )\n        activity.start()\n      }\n\n      if (typeof step === `function`) {\n        await step(helpers, pluginOptions)\n      } else if (Array.isArray(step)) {\n        await runSteps(step, helpers, pluginOptions, apiName)\n      }\n\n      if (activity) {\n        activity.end()\n      }\n    } catch (e) {\n      const sharedError = `Encountered a critical error when running the ${\n        apiName ? `${apiName}.` : ``\n      }${step.name} build step.`\n\n      // on errors, invoke any preview callbacks to send news of this error back to the WP Preview window.\n      await invokeAndCleanupLeftoverPreviewCallbacks({\n        status: `GATSBY_PREVIEW_PROCESS_ERROR`,\n        context: sharedError,\n        error: e,\n      })\n\n      console.error(e)\n      helpers.reporter.panic({\n        id: CODES.SourcePluginCodeError,\n        context: {\n          sourceMessage: formatLogMessage(\n            `\\n\\n\\t${sharedError}\\n\\tSee above for more information.`,\n            { useVerboseStyle: true }\n          ),\n        },\n      })\n    }\n  }\n}\n\n/**\n * Takes in a pipe delimited string of Gatsby Node API names and returns the first supported API name as a string\n *\n * Example input: \"onPluginInit|unstable_onPluginInit\"\n * Example output: \"onPluginInit\"\n */\nconst findApiName = (initialApiNameString: string): string => {\n  if (!initialApiNameString.includes(`|`)) {\n    return initialApiNameString\n  }\n\n  const potentialApiNames = initialApiNameString.split(`|`)\n\n  try {\n    const { isGatsbyNodeLifecycleSupported } = require(`gatsby-plugin-utils`)\n\n    for (const apiName of potentialApiNames) {\n      if (isGatsbyNodeLifecycleSupported(apiName)) {\n        return apiName\n      }\n    }\n  } catch (e) {\n    console.error(\n      `Could not check if Gatsby supports node API's [${potentialApiNames.join(\n        `, `\n      )}]. Trying to use the first available API name (${potentialApiNames[0]})`\n    )\n\n    return potentialApiNames[0]\n  }\n\n  throw new Error(\n    `Couldn't find any supported Gatsby Node API's in ${initialApiNameString}`\n  )\n}\n\nconst runApiSteps =\n  (steps: Array<Step>, apiName: string) =>\n  async (\n    helpers: GatsbyNodeApiHelpers,\n    pluginOptions: IPluginOptions\n  ): Promise<void> =>\n    runSteps(steps, helpers, pluginOptions, apiName)\n\nexport { runSteps, runApiSteps, findApiName }\n"],"mappings":"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"}