{"version":3,"file":"helpers.js","names":["buildInterfacesListForType","type","shouldAddNodeType","list","interfaces","filter","interfaceType","interfaceTypeSettings","getTypeSettingsByType","exclude","fieldOfTypeWasFetched","map","name","buildTypeName","push","ceIntCache","isWpgqlOneThirteenZeroPlus","typeMap","store","getState","remoteSchema","connectionInterface","get","edgeInterface","schema","typePrefix","prefix","getPluginOptions","endsWith","startsWith","findTypeKind","kind","ofType","findNamedType","findNamedTypeName","namedType","fetchedTypes","typeName","typeWasFetched","implementingTypeCache","Map","getTypesThatImplementInterfaceType","has","state","allTypes","values","implementingTypes","Array","from","find","singleInterface","possibleTypes","length","set","supportedScalars","typeIsABuiltInScalar","includes","typeIsASupportedScalar","typeSettingCache","cachedTypeSettings","allTypeSettings","gatsbyApi","pluginOptions","typeSettings","__allTypeSetting","__all","limit","mergedSettings","filterTypeDefinition","typeDefinition","typeBuilderApi","typeKind","filters","typeDefinitionFilters","forEach","typeDef","introspectionFieldTypeToSDL","fieldType","openingTagsList","closingTagsList","reference","normalizedTypeName","join","reverse"],"sources":["../../../src/steps/create-schema-customization/helpers.js"],"sourcesContent":["import store from \"~/store\"\nimport { typeDefinitionFilters } from \"./type-filters\"\nimport { getPluginOptions } from \"~/utils/get-gatsby-api\"\nimport { cloneDeep, merge } from \"lodash\"\n\nexport const buildInterfacesListForType = type => {\n  let shouldAddNodeType = false\n\n  const list = (type?.interfaces || [])\n    .filter(interfaceType => {\n      const interfaceTypeSettings = getTypeSettingsByType(interfaceType)\n\n      return (\n        !interfaceTypeSettings.exclude && fieldOfTypeWasFetched(interfaceType)\n      )\n    })\n    .map(({ name }) => {\n      if (name === `Node`) {\n        shouldAddNodeType = true\n      }\n      return buildTypeName(name)\n    })\n\n  if (shouldAddNodeType) {\n    list.push(`Node`)\n  }\n\n  return list\n}\n\nlet ceIntCache = null\nconst isWpgqlOneThirteenZeroPlus = () => {\n  if (ceIntCache !== null) {\n    return ceIntCache\n  }\n\n  const { typeMap } = store.getState().remoteSchema\n\n  const connectionInterface = !!typeMap.get(`Connection`)\n  const edgeInterface = !!typeMap.get(`Edge`)\n\n  const isWpgqlOneThirteenZeroPlus = connectionInterface || edgeInterface\n\n  ceIntCache = isWpgqlOneThirteenZeroPlus\n\n  return isWpgqlOneThirteenZeroPlus\n}\n\n/**\n * This function namespaces typenames with a prefix\n */\nexport const buildTypeName = name => {\n  if (!name || typeof name !== `string`) {\n    return null\n  }\n\n  const {\n    schema: { typePrefix: prefix },\n  } = getPluginOptions()\n\n  // this is for our namespace type on the root { wp { ...fields } }\n  if (name === prefix) {\n    return name\n  }\n\n  // Gatsby makes the same type, so we need to rename it to prevent conflicts\n  if (name === `Filter`) {\n    name = `FilterType`\n  }\n\n  if (\n    // Starting in WPGraphQL 1.13.0, Gatsby and WPGraphQL both generate types ending in these strings for every node type in the schema, so we need to rename types to prevent conflicts.\n    // for users on older versions of WPGraphQL we should try to keep the schema how it was before\n    isWpgqlOneThirteenZeroPlus() &&\n    (name.endsWith(`Connection`) ||\n      name.endsWith(`Edge`) ||\n      name.endsWith(`PageInfo`))\n  ) {\n    name += `Type`\n  }\n\n  if (name.startsWith(prefix)) {\n    return name\n  }\n\n  return prefix + name\n}\n\n/**\n * Find the first type kind of a Type definition pulled via introspection\n * @param {object} type\n */\nexport const findTypeKind = type => {\n  if (type?.kind) {\n    return type.kind\n  }\n\n  if (type?.ofType) {\n    return findTypeKind(type.ofType)\n  }\n\n  return null\n}\n\nexport const findNamedType = type => {\n  if (!type) {\n    return null\n  }\n\n  if (type.ofType) {\n    return findNamedType(type.ofType)\n  }\n\n  return type\n}\n\nexport const findNamedTypeName = type => {\n  const namedType = findNamedType(type)\n\n  return namedType?.name\n}\n\nexport const fieldOfTypeWasFetched = type => {\n  const { fetchedTypes } = store.getState().remoteSchema\n  const typeName = findNamedTypeName(type)\n  const typeWasFetched = !!fetchedTypes.get(typeName)\n\n  return typeWasFetched\n}\n\nconst implementingTypeCache = new Map()\n\nexport const getTypesThatImplementInterfaceType = type => {\n  if (implementingTypeCache.has(type.name)) {\n    return implementingTypeCache.get(type.name)\n  }\n\n  const state = store.getState()\n  const { typeMap } = state.remoteSchema\n\n  const allTypes = typeMap.values()\n\n  const implementingTypes = Array.from(allTypes)\n    .filter(\n      ({ interfaces }) =>\n        interfaces &&\n        // find types that implement this interface type\n        interfaces.find(singleInterface => singleInterface.name === type.name)\n    )\n    .map(type => typeMap.get(type.name))\n    .filter(\n      type =>\n        type.kind !== `UNION` ||\n        // if this is a union type, make sure the union type has one or more member types, otherwise schema customization will throw an error\n        (!!type.possibleTypes && !!type.possibleTypes.length)\n    )\n\n  implementingTypeCache.set(type.name, implementingTypes)\n\n  return implementingTypes\n}\n\nconst supportedScalars = [\n  `Int`,\n  `Float`,\n  `String`,\n  `Boolean`,\n  `ID`,\n  `Date`,\n  `JSON`,\n]\n\nexport const typeIsABuiltInScalar = type =>\n  // @todo the next function and this one are redundant.\n  // see the next todo on how to fix the issue. If that todo is resolved, these functions will be identical. :(\n  supportedScalars.includes(findNamedTypeName(type))\n\nexport const typeIsASupportedScalar = type => {\n  if (findTypeKind(type) !== `SCALAR`) {\n    // @todo returning true here seems wrong since a type that is not a scalar can't be a supported scalar... so there is some other logic elsewhere that is wrong\n    // making this return false causes errors in the schema\n    return true\n  }\n\n  return supportedScalars.includes(findNamedTypeName(type))\n}\n\nconst typeSettingCache = new Map()\n\n// retrieves plugin settings for the provided type\nexport const getTypeSettingsByType = type => {\n  if (!type) {\n    return {}\n  }\n\n  const typeName = findNamedTypeName(type)\n\n  if (!typeName) {\n    return {}\n  }\n\n  const cachedTypeSettings = typeSettingCache.get(typeName)\n\n  if (cachedTypeSettings) {\n    return cachedTypeSettings\n  }\n\n  // the plugin options object containing every type setting\n  const allTypeSettings = store.getState().gatsbyApi.pluginOptions.type\n\n  const typeSettings = cloneDeep(allTypeSettings[typeName] || {})\n\n  // the type.__all plugin option which is applied to every type setting\n  const __allTypeSetting = cloneDeep(allTypeSettings.__all || {})\n\n  if (typeName === `MediaItem`) {\n    delete __allTypeSetting.limit\n    delete typeSettings.limit\n  }\n\n  if (typeSettings) {\n    const mergedSettings = merge(__allTypeSetting, typeSettings)\n\n    typeSettingCache.set(typeName, mergedSettings)\n\n    return mergedSettings\n  }\n\n  typeSettingCache.set(typeName, __allTypeSetting)\n\n  return __allTypeSetting\n}\n\n/**\n * This is used to filter the automatically generated type definitions before they're added to the schema customization api.\n */\nexport const filterTypeDefinition = (\n  typeDefinition,\n  typeBuilderApi,\n  typeKind\n) => {\n  const filters = typeDefinitionFilters.filter(filter =>\n    [typeBuilderApi.type.name, `__all`].includes(filter.typeName)\n  )\n\n  if (filters?.length) {\n    filters.forEach(filter => {\n      if (filter && typeof filter.typeDef === `function`) {\n        typeDefinition = filter.typeDef(\n          typeDefinition,\n          typeBuilderApi,\n          typeKind\n        )\n      }\n    })\n  }\n\n  return typeDefinition\n}\n\n// we should be using graphql-js for this kind of thing, but unfortunately this project didn't use it from the beginning so it would be a huge lift to refactor to use it now. In the future we will be rewriting this plugin using a new Gatsby source plugin toolkit, and at that time we'll use graphql-js.\n// from introspection field types this will return a value like:\n// `String` or `[String]` or `[String!]!` or `[String]!` or `[[String]]` or `[[String]!]!` or `[[String]!]`, etc\nexport const introspectionFieldTypeToSDL = fieldType => {\n  const openingTagsList = []\n  const closingTagsList = []\n\n  let reference = fieldType\n\n  while (reference) {\n    switch (reference.kind) {\n      case `SCALAR`: {\n        const normalizedTypeName = supportedScalars.includes(reference.name)\n          ? reference.name\n          : `JSON`\n\n        openingTagsList.push(normalizedTypeName)\n        break\n      }\n      case `OBJECT`:\n      case `INTERFACE`:\n      case `UNION`:\n        openingTagsList.push(buildTypeName(reference.name))\n        break\n      case `NON_NULL`:\n        closingTagsList.push(`!`)\n        break\n      case `LIST`:\n        openingTagsList.push(`[`)\n        closingTagsList.push(`]`)\n        break\n      default:\n        break\n    }\n\n    reference = reference.ofType\n  }\n\n  return openingTagsList.join(``) + closingTagsList.reverse().join(``)\n}\n"],"mappings":"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"}