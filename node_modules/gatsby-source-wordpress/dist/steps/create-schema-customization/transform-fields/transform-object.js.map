{"version":3,"file":"transform-object.js","names":["transformListOfGatsbyNodes","field","fieldName","typeSDLString","introspectionFieldTypeToSDL","type","typeName","buildTypeName","findNamedTypeName","resolve","source","_args","context","nodes","Array","isArray","nodeModel","getNodesByIds","ids","map","node","id","buildGatsbyNodeObjectResolver","name","nodeField","existingNode","getNodeById","schema","typePrefix","prefix","getPluginOptions","__typename","startsWith","queryInfo","getQueryInfoByTypeName","isLazyMediaItem","typeInfo","nodesTypeName","settings","lazyNodes","inPreviewMode","usingGatsbyV4OrGreater","fetchAndCreateSingleNode","actionType","singleName","singularName","helpers","getGatsbyApi","actions","createParentChildLink","parent","child","transformGatsbyNodeObject","transformerApi"],"sources":["../../../../src/steps/create-schema-customization/transform-fields/transform-object.js"],"sourcesContent":["import { buildTypeName } from \"~/steps/create-schema-customization/helpers\"\nimport { fetchAndCreateSingleNode } from \"~/steps/source-nodes/update-nodes/wp-actions/update\"\nimport { getQueryInfoByTypeName } from \"~/steps/source-nodes/helpers\"\nimport { getGatsbyApi } from \"~/utils/get-gatsby-api\"\nimport { inPreviewMode } from \"~/steps/preview/index\"\nimport { getPluginOptions } from \"../../../utils/get-gatsby-api\"\nimport { usingGatsbyV4OrGreater } from \"~/utils/gatsby-version\"\nimport { findNamedTypeName, introspectionFieldTypeToSDL } from \"../helpers\"\n\nexport const transformListOfGatsbyNodes = ({ field, fieldName }) => {\n  const typeSDLString = introspectionFieldTypeToSDL(field.type)\n  const typeName = buildTypeName(findNamedTypeName(field.type))\n\n  return {\n    type: typeSDLString,\n    resolve: (source, _args, context) => {\n      let nodes = null\n\n      const field = source[fieldName]\n\n      if (field && Array.isArray(field)) {\n        nodes = field\n      } else if (Array.isArray(source?.nodes)) {\n        nodes = source.nodes\n      }\n\n      if (!nodes) {\n        return null\n      }\n\n      return context.nodeModel.getNodesByIds({\n        ids: nodes.map(node => node?.id),\n        type: typeName,\n      })\n    },\n  }\n}\n\nexport const buildGatsbyNodeObjectResolver =\n  ({ field, fieldName }) =>\n  async (source, _args, context) => {\n    const typeName = buildTypeName(field.type.name)\n    const nodeField = source[fieldName]\n\n    if (!nodeField || (nodeField && !nodeField.id)) {\n      return null\n    }\n\n    const existingNode = context.nodeModel.getNodeById({\n      id: nodeField.id,\n      type: typeName,\n    })\n\n    const {\n      schema: { typePrefix: prefix },\n    } = getPluginOptions()\n\n    if (\n      existingNode?.__typename &&\n      !existingNode.__typename.startsWith(prefix)\n    ) {\n      existingNode.__typename = buildTypeName(existingNode.__typename)\n    }\n\n    if (existingNode) {\n      return existingNode\n    }\n\n    const queryInfo = getQueryInfoByTypeName(field.type.name)\n\n    if (!queryInfo) {\n      // if we don't have query info for a type\n      // it probably means this type is excluded in plugin options\n      return null\n    }\n\n    const isLazyMediaItem =\n      queryInfo.typeInfo.nodesTypeName === `MediaItem` &&\n      queryInfo.settings.lazyNodes\n\n    if (\n      // only fetch/create nodes in resolvers for media items when they have lazyNodes enabled\n      (!isLazyMediaItem &&\n        // but if we're in preview mode we want to lazy fetch nodes\n        // because if nodes are limited we still want to lazy fetch connections\n        !inPreviewMode()) ||\n      // lazyNodes option isn't supported in Gatsby v4+\n      usingGatsbyV4OrGreater\n    ) {\n      return null\n    }\n\n    // if this node doesn't exist, fetch it and create a node\n    const { node } = await fetchAndCreateSingleNode({\n      id: nodeField.id,\n      actionType: `CREATE`,\n      singleName: queryInfo.typeInfo.singularName,\n    })\n\n    if (source.id && node) {\n      const { helpers } = getGatsbyApi()\n\n      await helpers.actions.createParentChildLink({\n        parent: source,\n        child: node,\n      })\n    }\n\n    return node || null\n  }\n\nexport const transformGatsbyNodeObject = transformerApi => {\n  const { field } = transformerApi\n  const typeName = buildTypeName(field.type.name)\n\n  return {\n    type: typeName,\n    resolve: buildGatsbyNodeObjectResolver(transformerApi),\n  }\n}\n"],"mappings":"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"}