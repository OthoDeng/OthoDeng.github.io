{"version":3,"file":"delete.js","names":["wpActionDELETE","helpers","wpAction","reporter","actions","getNode","cachedNodeIds","getPersistentCache","key","CREATED_NODE_IDS","nodeId","referencedNodeGlobalRelayID","node","typeInfo","getQueryInfoBySingleFieldName","referencedNodeSingularName","info","formatLogMessage","log","typeSettings","getTypeSettingsByType","name","nodesTypeName","beforeChangeNode","additionalNodeIds","actionType","remoteNode","fetchGraphql","buildTypeName","wpStore","store","length","forEach","id","push","touchNode","deleteNode","chalk","bold","title","referencedNodeID","validNodeIds","filter","cachedId","setPersistentCache","value","e","Object","entries","warn","JSON","stringify","Error","module","exports"],"sources":["../../../../../src/steps/source-nodes/update-nodes/wp-actions/delete.js"],"sourcesContent":["import chalk from \"chalk\"\n\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport store from \"~/store\"\nimport {\n  getTypeSettingsByType,\n  buildTypeName,\n} from \"~/steps/create-schema-customization/helpers\"\nimport { fetchGraphql } from \"~/utils/fetch-graphql\"\nimport { getQueryInfoBySingleFieldName } from \"../../helpers\"\nimport { CREATED_NODE_IDS } from \"~/constants\"\nimport { setPersistentCache, getPersistentCache } from \"~/utils/cache\"\n\nconst wpActionDELETE = async ({\n  helpers,\n  // cachedNodeIds,\n  wpAction,\n}) => {\n  const { reporter, actions, getNode } = helpers\n\n  try {\n    const cachedNodeIds = await getPersistentCache({ key: CREATED_NODE_IDS })\n\n    // get the node ID from the WPGQL id\n    const nodeId = wpAction.referencedNodeGlobalRelayID\n\n    const node = await getNode(nodeId)\n\n    const { typeInfo } =\n      getQueryInfoBySingleFieldName(wpAction.referencedNodeSingularName) || {}\n\n    if (!typeInfo) {\n      reporter.info(\n        formatLogMessage(\n          `A ${wpAction.referencedNodeSingularName} was deleted, but this node type is excluded in plugin options.`\n        )\n      )\n      reporter.log(``)\n      return\n    }\n\n    const typeSettings = getTypeSettingsByType({\n      name: typeInfo.nodesTypeName,\n    })\n\n    if (\n      typeSettings.beforeChangeNode &&\n      typeof typeSettings.beforeChangeNode === `function`\n    ) {\n      const { additionalNodeIds } =\n        (await typeSettings.beforeChangeNode({\n          actionType: `DELETE`,\n          remoteNode: node,\n          actions,\n          helpers,\n          typeInfo,\n          fetchGraphql,\n          typeSettings,\n          buildTypeName,\n          wpStore: store,\n        })) || {}\n\n      if (additionalNodeIds && additionalNodeIds.length) {\n        additionalNodeIds.forEach(id => cachedNodeIds.push(id))\n      }\n    }\n\n    if (node) {\n      await actions.touchNode(node)\n      await actions.deleteNode(node)\n\n      reporter.log(``)\n      reporter.info(\n        formatLogMessage(\n          `${chalk.bold(`deleted ${wpAction.referencedNodeSingularName}`)} ${\n            wpAction.title\n          } (#${wpAction.referencedNodeID})`\n        )\n      )\n\n      reporter.log(``)\n    }\n\n    // Remove this from cached node id's so we don't try to touch it\n    const validNodeIds = cachedNodeIds.filter(cachedId => cachedId !== nodeId)\n\n    await setPersistentCache({ key: CREATED_NODE_IDS, value: validNodeIds })\n\n    // return validNodeIds\n  } catch (e) {\n    Object.entries(wpAction).forEach(([key, value]) => {\n      reporter.warn(`${key} ${JSON.stringify(value)}`)\n    })\n    throw Error(e)\n  }\n}\n\nmodule.exports = wpActionDELETE\n"],"mappings":"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"}