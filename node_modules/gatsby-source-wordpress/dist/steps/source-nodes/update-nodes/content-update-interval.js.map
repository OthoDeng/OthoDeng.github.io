{"version":3,"file":"content-update-interval.js","names":["checkForNodeUpdates","cache","emitter","store","dispatch","develop","pauseRefreshPolling","lastCompletedSourceTime","get","LAST_COMPLETED_SOURCE_TIME","since","data","actionMonitorActions","nodes","newActions","fetchGraphql","query","contentPollingQuery","variables","throwGqlErrors","throwFetchErrors","length","emit","webhookBody","refreshing","pluginName","set","Date","now","resumeRefreshPolling","refetcher","msRefetchInterval","helpers","reconnectionActivity","retryCount","refreshPollingIsPaused","getState","end","reporter","success","formatLogMessage","e","pluginOptions","getGatsbyApi","debug","throwRefetchErrors","activityTimer","message","start","setStatus","retryTime","maxWait","waitFor","Promise","resolve","setTimeout","startedPolling","firstCompilationDone","startPollingForContentUpdates","process","env","WP_DISABLE_POLLING","ENABLE_GATSBY_REFRESH_ENDPOINT","verbose","gatsbyApi","nodeUpdateInterval","on","log","info"],"sources":["../../../../src/steps/source-nodes/update-nodes/content-update-interval.js"],"sourcesContent":["import { formatLogMessage } from \"~/utils/format-log-message\"\nimport store from \"~/store\"\nimport { getGatsbyApi } from \"~/utils/get-gatsby-api\"\nimport { contentPollingQuery } from \"../../../utils/graphql-queries\"\nimport fetchGraphql from \"../../../utils/fetch-graphql\"\nimport { LAST_COMPLETED_SOURCE_TIME } from \"../../../constants\"\n\n/**\n * This function checks wether there is atleast 1 WPGatsby action ready to be processed by Gatsby\n * If there is, it calls the refresh webhook so that schema customization and source nodes run again.\n */\nconst checkForNodeUpdates = async ({ cache, emitter }) => {\n  // pause polling until we know wether or not there are new actions\n  // if there aren't any we will unpause below, if there are some we will unpause\n  // at the end of sourceNodes (triggered by WEBHOOK_RECEIVED below)\n  store.dispatch.develop.pauseRefreshPolling()\n\n  // get the last sourced time\n  const lastCompletedSourceTime = await cache.get(LAST_COMPLETED_SOURCE_TIME)\n  const since = lastCompletedSourceTime - 500\n\n  // make a graphql request for any actions that have happened since\n  const {\n    data: {\n      actionMonitorActions: { nodes: newActions },\n    },\n  } = await fetchGraphql({\n    query: contentPollingQuery,\n    variables: {\n      since,\n    },\n    // throw fetch errors and graphql errors so we can auto recover in refetcher()\n    throwGqlErrors: true,\n    throwFetchErrors: true,\n  })\n\n  if (newActions.length) {\n    emitter.emit(`WEBHOOK_RECEIVED`, {\n      webhookBody: {\n        since,\n        refreshing: true,\n      },\n      pluginName: `gatsby-source-wordpress`,\n    })\n  } else {\n    // set new last completed source time and move on\n    await cache.set(LAST_COMPLETED_SOURCE_TIME, Date.now())\n    store.dispatch.develop.resumeRefreshPolling()\n  }\n}\n\nconst refetcher = async (\n  msRefetchInterval,\n  helpers,\n  { reconnectionActivity = null, retryCount = 1 } = {}\n) => {\n  try {\n    const { refreshPollingIsPaused } = store.getState().develop\n\n    if (!refreshPollingIsPaused) {\n      await checkForNodeUpdates(helpers)\n    }\n\n    if (reconnectionActivity) {\n      reconnectionActivity.end()\n      helpers.reporter.success(\n        formatLogMessage(\n          `Content updates re-connected after ${retryCount} ${\n            retryCount === 1 ? `try` : `tries`\n          }`\n        )\n      )\n\n      reconnectionActivity = null\n      retryCount = 1\n    }\n  } catch (e) {\n    const { pluginOptions } = getGatsbyApi()\n    if (pluginOptions?.debug?.throwRefetchErrors) {\n      throw e\n    }\n\n    if (!reconnectionActivity) {\n      reconnectionActivity = helpers.reporter.activityTimer(\n        formatLogMessage(`Content update error: \"${e.message}\"`)\n      )\n      reconnectionActivity.start()\n      reconnectionActivity.setStatus(`retrying...`)\n    } else {\n      retryCount++\n      reconnectionActivity.setStatus(`retried ${retryCount} times`)\n    }\n\n    // retry after retry count times 5 seconds\n    const retryTime = retryCount * 5000\n    // if the retry time is greater than or equal to the max (60 seconds)\n    // use the max, otherwise use the retry time\n    const maxWait = 60000\n    const waitFor = retryTime >= maxWait ? maxWait : retryTime\n\n    await new Promise(resolve => setTimeout(resolve, waitFor))\n  }\n\n  setTimeout(\n    () =>\n      refetcher(msRefetchInterval, helpers, {\n        reconnectionActivity,\n        retryCount,\n      }),\n    msRefetchInterval\n  )\n}\n\nlet startedPolling = false\nlet firstCompilationDone = false\n\n/**\n * Starts constantly refetching the latest WordPress changes\n * so we can update Gatsby nodes when data changes\n */\nconst startPollingForContentUpdates = helpers => {\n  if (\n    startedPolling ||\n    process.env.WP_DISABLE_POLLING ||\n    process.env.ENABLE_GATSBY_REFRESH_ENDPOINT\n  ) {\n    return\n  }\n\n  startedPolling = true\n\n  const { verbose, develop } = store.getState().gatsbyApi.pluginOptions\n\n  const msRefetchInterval = develop.nodeUpdateInterval\n\n  helpers.emitter.on(`COMPILATION_DONE`, () => {\n    /**\n     * we only want to start our refetcher helper 1 time after the first COMPILATION_DONE event.\n     * This event happens when the dev server is ready. It also happens after saving a code change. We only want to run our code 1 time.\n     * onCreateDevServer (the node API we're hooking into) is called before the dev server is ready.\n     * Running our logic at that point is problematic because we could end up triggering the WEBHOOK_RECEIVED event before the dev server is ready and this can cause Gatsby to throw errors. So we're hooking into COMPILATION_DONE to avoid that problem.\n     */\n    if (!firstCompilationDone) {\n      firstCompilationDone = true\n\n      // wait a second so that terminal output is more smooth\n      setTimeout(() => {\n        if (verbose) {\n          helpers.reporter.log(``)\n          helpers.reporter.info(\n            formatLogMessage`Watching for WordPress changes`\n          )\n        }\n\n        refetcher(msRefetchInterval, helpers)\n      }, 1000)\n    }\n  })\n}\n\nexport { startPollingForContentUpdates }\n"],"mappings":"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"}