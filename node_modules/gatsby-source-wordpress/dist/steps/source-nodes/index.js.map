{"version":3,"file":"index.js","names":["sourceNodes","helpers","cache","webhookBody","refetchAll","nonNodeRootFieldsPromise","fetchAndCreateNonNodeRootFields","token","userDatabaseId","sourcePreviews","now","Date","lastCompletedSourceTime","refreshing","since","get","LAST_COMPLETED_SOURCE_TIME","schemaWasChanged","foundUsableHardCachedData","store","getState","remoteSchema","fetchEverything","process","env","NODE_ENV","fetchAndCreateAllNodes","fetchAndApplyNodeUpdates","allowFileDownloaderProgressBarToClear","set","dispatch","setSchemaWasChanged","develop","resumeRefreshPolling"],"sources":["../../../src/steps/source-nodes/index.ts"],"sourcesContent":["import { Step } from \"./../../utils/run-steps\"\nimport fetchAndApplyNodeUpdates from \"./update-nodes/fetch-node-updates\"\n\nimport { fetchAndCreateAllNodes } from \"./fetch-nodes/fetch-nodes\"\n\nimport { LAST_COMPLETED_SOURCE_TIME } from \"~/constants\"\nimport store from \"~/store\"\nimport fetchAndCreateNonNodeRootFields from \"./create-nodes/fetch-and-create-non-node-root-fields\"\nimport { allowFileDownloaderProgressBarToClear } from \"./create-nodes/create-remote-file-node/progress-bar-promise\"\nimport { sourcePreviews } from \"~/steps/preview\"\n\nconst sourceNodes: Step = async helpers => {\n  const { cache, webhookBody, refetchAll } = helpers\n\n  // fetch non-node root fields such as settings.\n  // For now, we're refetching them on every build\n  const nonNodeRootFieldsPromise = fetchAndCreateNonNodeRootFields()\n\n  // if this is a preview we want to process it and return early\n  if (webhookBody.token && webhookBody.userDatabaseId) {\n    await sourcePreviews(helpers)\n    await nonNodeRootFieldsPromise\n    return\n  }\n\n  const now = Date.now()\n\n  const lastCompletedSourceTime =\n    webhookBody.refreshing && webhookBody.since\n      ? webhookBody.since\n      : await cache.get(LAST_COMPLETED_SOURCE_TIME)\n\n  const { schemaWasChanged, foundUsableHardCachedData } =\n    store.getState().remoteSchema\n\n  const fetchEverything =\n    foundUsableHardCachedData ||\n    !lastCompletedSourceTime ||\n    refetchAll ||\n    // don't refetch everything in development\n    (process.env.NODE_ENV !== `development` &&\n      // and the schema was changed\n      schemaWasChanged)\n\n  // If this is an uncached build,\n  // or our initial build to fetch and cache everything didn't complete,\n  // pull everything from WPGQL\n  if (fetchEverything) {\n    await fetchAndCreateAllNodes()\n  }\n\n  // If we've already successfully pulled everything from WPGraphQL\n  // just pull the latest changes\n  else if (!fetchEverything) {\n    await fetchAndApplyNodeUpdates({\n      since: lastCompletedSourceTime,\n    })\n  }\n\n  await nonNodeRootFieldsPromise\n\n  allowFileDownloaderProgressBarToClear()\n  await helpers.cache.set(LAST_COMPLETED_SOURCE_TIME, now)\n\n  const { dispatch } = store\n  dispatch.remoteSchema.setSchemaWasChanged(false)\n  dispatch.develop.resumeRefreshPolling()\n}\n\nexport { sourceNodes }\n"],"mappings":";;;;;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA,MAAMA,WAAiB,GAAG,MAAMC,OAAO,IAAI;EACzC,MAAM;IAAEC,KAAK;IAAEC,WAAW;IAAEC;EAAW,CAAC,GAAGH,OAAO;;EAElD;EACA;EACA,MAAMI,wBAAwB,GAAG,IAAAC,wCAA+B,GAAE;;EAElE;EACA,IAAIH,WAAW,CAACI,KAAK,IAAIJ,WAAW,CAACK,cAAc,EAAE;IACnD,MAAM,IAAAC,uBAAc,EAACR,OAAO,CAAC;IAC7B,MAAMI,wBAAwB;IAC9B;EACF;EAEA,MAAMK,GAAG,GAAGC,IAAI,CAACD,GAAG,EAAE;EAEtB,MAAME,uBAAuB,GAC3BT,WAAW,CAACU,UAAU,IAAIV,WAAW,CAACW,KAAK,GACvCX,WAAW,CAACW,KAAK,GACjB,MAAMZ,KAAK,CAACa,GAAG,CAACC,qCAA0B,CAAC;EAEjD,MAAM;IAAEC,gBAAgB;IAAEC;EAA0B,CAAC,GACnDC,cAAK,CAACC,QAAQ,EAAE,CAACC,YAAY;EAE/B,MAAMC,eAAe,GACnBJ,yBAAyB,IACzB,CAACN,uBAAuB,IACxBR,UAAU;EACV;EACCmB,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAM,aAAY;EACrC;EACAR,gBAAiB;;EAErB;EACA;EACA;EACA,IAAIK,eAAe,EAAE;IACnB,MAAM,IAAAI,kCAAsB,GAAE;EAChC;;EAEA;EACA;EAAA,KACK,IAAI,CAACJ,eAAe,EAAE;IACzB,MAAM,IAAAK,yBAAwB,EAAC;MAC7Bb,KAAK,EAAEF;IACT,CAAC,CAAC;EACJ;EAEA,MAAMP,wBAAwB;EAE9B,IAAAuB,yDAAqC,GAAE;EACvC,MAAM3B,OAAO,CAACC,KAAK,CAAC2B,GAAG,CAACb,qCAA0B,EAAEN,GAAG,CAAC;EAExD,MAAM;IAAEoB;EAAS,CAAC,GAAGX,cAAK;EAC1BW,QAAQ,CAACT,YAAY,CAACU,mBAAmB,CAAC,KAAK,CAAC;EAChDD,QAAQ,CAACE,OAAO,CAACC,oBAAoB,EAAE;AACzC,CAAC;AAAA"}