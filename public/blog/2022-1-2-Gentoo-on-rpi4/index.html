<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.4.2"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style data-styled="" data-styled-version="5.3.6"></style><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=5ca9199a87ba5b458c8d486164220156" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5ca9199a87ba5b458c8d486164220156"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5ca9199a87ba5b458c8d486164220156"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5ca9199a87ba5b458c8d486164220156"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5ca9199a87ba5b458c8d486164220156"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5ca9199a87ba5b458c8d486164220156"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5ca9199a87ba5b458c8d486164220156"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5ca9199a87ba5b458c8d486164220156"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5ca9199a87ba5b458c8d486164220156"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><main align="left" style="color:#EF9A9A"><title>Gentoo-on-rpi4</title>
<h1>Gentoo-on-rpi4</h1>
<h2>基础安装</h2>
<h3>SD卡的准备</h3>
<p>首先准备SD card 一张。在SD 卡上至少创建两个分区。
SD的/ boot分区应该是FAT32。根（/分区可以是任何首选的 Linux文件系统，但是由于 SD 卡是基于闪存的介质，使用F2FS有很多好处。
大致情况可以如下：</p>
<pre><code class="language-bash">	Disk /dev/sdb: 16.6 GB, 16574840832 bytes
	255 heads, 63 sectors/track, 2015 cylinders, total 32372736 sectors
	Units = sectors of 1 * 512 = 512 bytes
	Sector size (logical/physical): 512 bytes / 512 bytes
	I/O size (minimum/optimal): 512 bytes / 512 bytes
	Disk identifier: 0x1db42224
	
	Device Boot      Start         End      Blocks   Id  System
	/dev/sdb1   *        2048      835379      416666    c  W95 FAT32 (LBA)
	/dev/sdb2          835380    31889024    15526822+  83  Linux
	/dev/sdb3        31889025    32372735      241855+   5  Extended
	/dev/sdb5        31889088    32372735      241824   82  Linux swap / Solaris
</code></pre>
<h3>发行版的选择</h3>
<p>树莓派使用的是ARM架构的linux系统。对于发行版，我们可以选择Debian系下的产品（如Ubuntu的server版本，也可以选择树莓派的官方镜像）
而我这次选择的是Gentoo Linux，因为它支持arm架构，同时支持32位，同时Gentoo Linux 支持编译整个系统，把原来官方提供的stage3 tarball里的所有组件替换成自己编译的（包括GCC编译器和所有基本系统组件），这样一来整个系统的所有程序和组件都是针对树莓派CPU架构优化编译的了，争取性能最大化。</p>
<h3>启动分区</h3>
<p>正确的/boot分区的最低设置需要以下由 Raspberry Pi 基金会提供的<a href="https://github.com/raspberrypi/firmware">专有固件文件</a>
<code>bootcode.bin</code>
<code>fixup.dat</code>
<code>start.elf</code>
<code>kernel image(s)</code></p>
<p><code>DTB (Device Tree Blob) files</code></p>
<p>要使用config.txt 中的gpu_mem=16设置启动树莓派，需要以下文件：
ge3-armv7a_hardfp-YYYYMMDD.tar.bz2 -C /mnt/raspberrypiroot/
fixup_cd.dat
start_cd.elf</p>
<p>Pi 有两个视频驱动程序。较旧的使用固定的保留 GPU 内存空间。开源 VC4 驱动程序使用内核连续内存分配器。使用vc4驱动时设置gpu_mem=16，避免浪费RAM。
我们可以merge一个sys-boot/raspberrypi-firmware来是它运行。</p>
<p>root #emerge --ask sys-boot/raspberrypi-firmware</p>
<p><strong>固件文件安装在/boot 中。在出现sys-boot/raspberrypi-firmware包之前，应将 SD 卡的引导分区挂载在/boot上。</strong>
或者我们可以选择安装预编译好的树莓派内核以及模块：</p>
<p>root #emerge --ask sys-kernel/raspberrypi-image</p>
<h3>下载并解压stage3</h3>
<pre><code class="language-shell">	wget http://distfiles.gentoo.org/releases/arm/autobuilds/current-stage3-armv7a_hardfp/stage3-armv7a_hardfp-YYYYMMDD.tar.bz2
	#国内的镜像源可能并未同步该镜像
	tar xpjf stage3-armv7a_hardfp-YYYYMMDD.tar.bz2 -C /mnt/raspberrypiroot/
</code></pre>
<h3>修改make.conf</h3>
<pre><code class="language-shell">	nano -w /mnt/raspberrypiroot/etc/portage/make.conf


	# Raspberry Pi 2, or Raspberry Pi 3 running in 32 bit mode:
	CFLAGS=&quot;-O2 -march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard&quot;
	CXXFLAGS=&quot;${CFLAGS}&quot;
</code></pre>
<h3>修改fstab</h3>
<p>我们使用lsblk以及blkid命令来查找分区。
SD卡一般被识别为/dev/mmcblk0
ge3-armv7a_hardfp-YYYYMMDD.tar.bz2 -C /mnt/raspberrypiroot/</p>
<h3>生成root密码的hash，并添加至/etc/shadow</h3>
<p>root #openssl passwd -1</p>
<h3>（可选）stage4文件</h3>
<p><a href="https://github.com/raspberrypi/noobs">每日NOOBS image会更新</a>
解压时解压在/os/Gentoo</p>
<h3>Portage树</h3>
<p>下载最新的 Portage 树：</p>
<p>root #wget http://distfiles.gentoo.org/snapshots/portage-latest.tar.bz2</p>
<p>确保根分区上有足够的空闲 inode 块。Portage 占用大约 181K 的 inode。</p>
<p>root #df -ih | grep -E &#x27;Mounted|mmc&#x27;</p>
<p>将 Portage 解压到 SD 卡：</p>
<p>root #tar xjvpf portage-latest.tar.bz2 -C /mnt/raspberrypiroot/usr</p>
<h3>交叉编译</h3>
<p>由于树莓派处理器相比现代处理器差了很多，为了加快Gentoo的安装过程，我们可以选择使用另一台机子进行编译作业。
使用crossdev：</p>
<p>root #emerge --ask sys-devel/crossdev</p>
<p>对于 64 位模式的 Raspberry ：</p>
<p>root #crossdev -S -t aarch64-unknown-linux-gnu --genv &#x27;USE=&quot;cxx multilib fortran -mudflap nls openmp -sanitize&quot;&#x27; #USE变量一定要配置！！！
root #cd /usr/aarch64-unknown-linux-gnu/etc/portage &amp;&amp; rm make.profile &amp;&amp; ln -s /usr/portage/profiles/default/linux/arm64/13.0/desktop make.profile</p>
<p>在另一主机上：</p>
<pre><code class="language-shell">gentoo_pc ~ # emerge --ask --verbose sys-devel/crossdev`
</code></pre>
<p>修改/etc/portage/repos.conf/crossdev.conf：</p>
<p>[crossdev]</p>
<p>location = /usr/local/portage-crossdev
priority = 10
masters = gentoo
auto-sync = no</p>
<p>准备USE变量：</p>
<p>gentoo_pc ~ # mkdir -pv /usr/local/portage-crossdev
gentoo_pc ~ # crossdev --stable -t aarch64-unknown-linux-gnu -oO /usr/local/portage-crossdev</p>
<p>跑完之后，我们的交叉编译工具链已经配置好了：
我们进入到portage：</p>
<pre><code class="language-shell">gentoo_pc ~ # cd /usr/aarch64-unknown-linux-gnu/etc/portage

gentoo_pc portage # rm -f make.profile
gentoo_pc portage # ln -s /usr/portage/profiles/default/linux/arm64/17.0/desktop make.profile
</code></pre>
<p>检查toolchain：</p>
<p>gentoo_pc ~ # aarch64-unknown-linux-gnu-gcc --version
gentoo_pc ~ # aarch64-unknown-linux-gnu-c++ --version
gentoo_pc ~ # aarch64-unknown-linux-gnu-g++ --version</p>
<p>如果架构的选择没正确，我们就需要重新选择config，再source新的profile，示例如下：</p>
<p>gentoo_pc ~ # gcc-config -l
[1] aarch64-unknown-linux-gnu-5.4.0</p>
<p>[2] x86_64-pc-linux-gnu-4.9.4
[3] x86_64-pc-linux-gnu-5.4.0 * #选择了错误的架构</p>
<p>gentoo_pc ~ # gcc-config aarch64-unknown-linux-gnu-5.4.0
gentoo_pc ~ # source /etc/profile</p>
<h3>在chroot里编译</h3>
<p>可以使用通用的 x86_64 或 i386 PC 来 chroot 到带有 Raspberry Pi 系统的现有 SD 卡。这种方法比在 Raspberry Pi 上编译要快得多。
为此，需要静态安装app-emulation/qemu：</p>
<pre><code class="language-shell">    root #echo app-emulation/qemu static-user qemu_user_targets_aarch64 qemu_user_targets_arm &gt;&gt; /etc/portage/package.use/qemu #写入USE变量
    root #emerge qemu	
    root #quickpkg qemu
</code></pre>
<p>在创建带有 <code>static-user</code> USE 标志的 QEMU 之后，需要将qemu-arm可执行文件复制到 chrooting 系统中：</p>
<p>root #cd /mnt/rpi
root #ROOT=$PWD/ emerge --usepkgonly --oneshot --nodeps qemu</p>
<p>完成后，需要在运行内核中用 ARM 可执行解释器：</p>
<p>root #echo &#x27;:arm:M::\x7fELF\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x28\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-arm:&#x27; &gt; /proc/sys/fs/binfmt_misc/register
root #echo &#x27;:aarch64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\xb7\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-aarch64:&#x27; &gt; /proc/sys/fs/binfmt_misc/register</p>
<h3>挂载文件系统</h3>
<p>root #mount /dev/mmcblk0p1 /mnt/rpi/boot
root #mount -o bind /dev /mnt/rpi/dev
root #mount -o bind /proc /mnt/rpi/proc
root #mount -o bind /sys /mnt/rpi/sys
root #mount -o rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000 devpts /mnt/rpi/dev/pts -t devpts</p>
<h3>复制DNS信息</h3>
<p>root #cp /etc/resolv.conf /mnt/rpi/etc/</p>
<p>最后chroot进入树莓派系统：</p>
<p>root #chroot /mnt/rpi</p>
<h3>编译内核</h3>
<p>Linux内核是所有发行版的核心。它位于用户程序和系统硬件之间。</p>
<p>root #emerge --ask sys-kernel/raspberrypi-sources</p>
<p>同样，我们可以选择手动配置内核或者使用genkernel来自动配置并编译内核：
这里我们选择使用genkernel来自动配置：
修改一下配置：</p>
<pre><code class="language-bash">/etc/genkernel-rpi.conf
        
# install kernel manually
INSTALL=&quot;no&quot;
        
#  Set arch to arm
ARCH_OVERRIDE=&quot;arm&quot;
        
# No need to mount BOOTDIR and make symlink as the kernel is
# installed manually
MOUNTBOOT=&quot;no&quot;
SYMLINK=&quot;no&quot;
        
# Adjust this as needed for the machine.
MAKEOPTS=&quot;-j3&quot;
        
# For  Raspberry Pi 3 B in 32/64-bit mode
UTILS_CROSS_COMPILE=&quot;armv7a-unknown-linux-gnueabihf-&quot;
KERNEL_CROSS_COMPILE=&quot;armv7a-unknown-linux-gnueabihf-&quot;
KERNEL_CC=&quot;armv7a-unknown-linux-gnueabihf-gcc&quot;
KERNEL_AS=&quot;armv7a-unknown-linux-gnueabihf-as&quot;
KERNEL_LD=&quot;armv7a-unknown-linux-gnueabihf-ld&quot;
        
# Change this to the path of raspberrypi linux kernel sources.
# It is possible to make this a symlink pointing to the
# /usr/src/linux-rpi like it&#x27;s done with a normal kernel.
# For example: ln -s /usr/src/linux-3.6.11-raspberrypi /usr/src/linux-rpi
DEFAULT_KERNEL_SOURCE=&quot;/usr/src/linux-rpi&quot;
        
# Point this variable to the directory where the SD card is mounted.
# Note that the location needs to be mounted manually before running genkernel.
INSTALL_MOD_PATH=&quot;/mnt/raspberrypiroot&quot;
        
# Genkernel needs access so /usr/share/genkernel (This folder contains default
# environment variables, scripts and source tarballs that enable genkernel to
# work).
GK_SHARE=&quot;${GK_SHARE:-/usr/share/genkernel}&quot;
DISTDIR=&quot;${GK_SHARE}/distfiles&quot;
        
# Genkernel also needs to have a logfile to write to. Without this present,
# you&#x27;ll see &quot;ambiguous redirect&quot; printed out many times between legitimate
# messages.
LOGFILE=&quot;/var/log/genkernel.log&quot;
</code></pre>
<p>保存配置文件。
挂载树莓派SD卡（假设树莓派的根分区设备是/dev/sdd3）：</p>
<p>root #mount /dev/sdd3 /mnt/raspberrypiroot</p>
<p>genkernel配置：</p>
<p>root #ARCH=arm genkernel --config=/etc/genkernel-rpi2.conf --kernel-config=/usr/src/linux-rpi/arch/arm/configs/bcm2709_defconfig kernel</p>
<p>保存配置/usr/local/bin/genkernel-rpi.sh:</p>
<pre><code class="language-bash">#!/bin/sh
ARCH=arm genkernel --config=/etc/genkernel-rpi2.conf --kernel-config=/usr/src/linux-rpi/arch/arm/configs/bcm2709_defconfig kernel


root #chmod +x /usr/local/bin/genkernel-rpi.sh
</code></pre>
<p>以上步骤是在完善genkernel的一些基本配置，现在我们就可以为我们的树莓派去跑genkernel命令了。</p>
<p>root #genkernel-rpi.sh</p>
<h3>安装kernel image</h3>
<p>这个步骤在实操过程中是比较棘手的，对于生成在/mnt/raspberrypiroot/boot/kernel.img可能无法正确引导kernel，这时候我们可能要使用到就一些版本的固件：</p>
<p>root #emerge --ask sys-boot/raspberrypi-mkimage
root #imagetool-uncompressed.py arch/arm/boot/Image /mnt/raspberrypiroot/boot/kernel.img</p>
<h3>安装WiFi 蓝牙固件</h3>
<p>root #emerge sys-kernel/linux-firmware</p>
<p>对于树莓派内置的 Wi-Fi 驱动程序brcmfmac会需要二进制固件 blob brcmfmac434*-sdio.bin。因此我们可能要配置一下brcmfmac434*-sdio.txt才能正常运行。</p>
<p>对于蓝牙，我们需要BCM43430A1.hcd 这个文件来支持运行。我们可以在树莓派官网蓝牙固件处找到，最后只需要将其配置到/lib/firmware/brcm处</p>
<pre><code class="language-shell">	root #mkdir -p /lib/firmware/brcm
	root #wget -P /lib/firmware/brcm https://raw.githubusercontent.com/RPi-Distro/bluez-firmware/master/broadcom/BCM4345C0.hcd
</code></pre>
<h3>VideoCore4</h3>
<p>要在 RPi 设备上启用 VideoCore4 GPU 加速，请将以下内容添加到/boot/config.txt：</p>
<p>/boot/config.txt
dtoverlay = vc4-kms-v3d,cma-128</p>
<p>最后还要在我们的make.conf添加:</p>
<p>VIDEO_CARDS = &quot;vc4&quot;</p>
<hr/>
<a align="center" color="#F2ABBD" width="100%" textAlign="center" paddingBottom="0.5rem" paddingTop="0.5rem"><p><a href="../">Go Back</a></p><p><p>Projects by<!-- --> </p><a href="https://github.com/ottoqwq"> <hi>Otto Deng</hi></a><p>. Powered by <a href="https://www.gatsbyjs.com/">Gatsby</a></p></p><p><p>Content on this site is licensed under<!-- --> <!-- -->
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> <!-- -->
unless specified.</p></p></a></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2022-1-2-Gentoo-on-rpi4/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-315254a0e4e6a65c564f.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-ee2ee4cab37162bc5df3.js\"],\"component---src-pages-about-js\":[\"/component---src-pages-about-js-618caafbda8e93c6c2ff.js\"],\"component---src-pages-blog-2021-8-21-媒介化生存-mdx\":[\"/component---src-pages-blog-2021-8-21-媒介化生存-mdx-a2d161b2312a294a9367.js\"],\"component---src-pages-blog-2022-1-2-gentoo-on-rpi-4-mdx\":[\"/component---src-pages-blog-2022-1-2-gentoo-on-rpi-4-mdx-c58a6ef8326eb83542b8.js\"],\"component---src-pages-blog-2022-12-31-2022-总结-mdx\":[\"/component---src-pages-blog-2022-12-31-2022-总结-mdx-6e55fa9119ca7294aee5.js\"],\"component---src-pages-blog-2022-4-11-神圣时间-mdx\":[\"/component---src-pages-blog-2022-4-11-神圣时间-mdx-5c23cf3e11ec80747e8f.js\"],\"component---src-pages-blog-2022-7-18-hello-new-world-js\":[\"/component---src-pages-blog-2022-7-18-hello-new-world-js-7555a5a4a71ca85f7123.js\"],\"component---src-pages-blog-2023-1-20-在-18-岁写下的话-mdx\":[\"/component---src-pages-blog-2023-1-20-在-18-岁写下的话-mdx-9ebfb4571721824c1a8e.js\"],\"component---src-pages-blog-js\":[\"/component---src-pages-blog-js-26176582f80c380b6dfd.js\"],\"component---src-pages-blog-sample-mdx\":[\"/component---src-pages-blog-sample-mdx-e89574562aafb22bdecf.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-22659cf7a7c62af755a7.js\"],\"component---src-pages-posts-js\":[\"/component---src-pages-posts-js-7478c0a39fced9a6aa8e.js\"],\"component---src-pages-study-chi-2022-7-17-of-poetry-mdx\":[\"/component---src-pages-study-chi-2022-7-17-of-poetry-mdx-d2cf6fa7832613dcac02.js\"],\"component---src-pages-study-chi-js\":[\"/component---src-pages-study-chi-js-78f1739025dca53f8fb0.js\"],\"component---src-pages-study-js\":[\"/component---src-pages-study-js-56a17b7b1c03e0a1fcc2.js\"],\"component---src-pages-study-math-js\":[\"/component---src-pages-study-math-js-9cfa511ecf650f8a4647.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="a11f14abf2aa04281af3";</script><script src="/webpack-runtime-67b7bde0b37f9b816c18.js" async></script><script src="/framework-1550d642695959fbbd09.js" async></script><script src="/app-315254a0e4e6a65c564f.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>